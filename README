This is the documentation for Anita, an Automated NetBSD Installation
and Test Application.

Anita is an experimental tool for automated testing of the NetBSD/i386
installation procedure.  Using anita, you can download a NetBSD/i386
distribution and install it in a qemu virtual machine in a fully
automated fashion.  It's fun to watch, and it has already played a
part in finding several bugs in NetBSD.

Anita is written in Python and uses the pexpect module to "screen
scrape" the sysinst output over an emulated serial console and
script the installation procedure.

Anita is still a work in progress.  Currently, it only knows how to
install the i386 port of NetBSD, but it should be possible to add
support for installing other ports, as well as cross-installation
setups where the machine running anita is a different architecture
from the virtual machine being installed on.

If you want to play with it, here is what you need:

 - The latest anita tarball from
   <http://www.gson.org/netbsd/anita/download/>

 - A system running NetBSD-current.  NetBSD 4.0 should also work, but
   has not been tested by the author.  Versions older than August 7,
   2006 will not work due to the bug reported in kern/34129.  Note
   that this requirement concerns the host system (the one you run
   anita on), not the target system (the one being installed in the
   virtual machine)

 - pkgsrc/emulators/qemu

 - pkgsrc/devel/py-pexpect

 - sysutils/cdrtools

 - A network connection for downloading installation file sets

 - About a gigabyte of free disk space

Unpack the anita tarball and cd into the resulting directory.  You
should now be able to download and install a NetBSD release in a
virtual machine using a one-line shell command.  For example, to
install NetBSD 4.0 from the master NetBSD FTP site, enter

   ./anita install http://ftp.netbsd.org/pub/NetBSD/NetBSD-4.0/i386/

To install a snapshot, use something like the following.  The URL in
this example will have expired by the time you read this, but if you
replace the date with a current one, it should work:

   ./anita install http://ftp.netbsd.org/pub/NetBSD-daily/netbsd-4/200802140000Z/i386/

To install from an ISO image:

   ./anita install i386cd-4.0.iso

If you have built NetBSD locally using "build.sh -R", you can point
Anita directly at the RELEASEDIR:

  ./anita install file:///path/to/releasedir/

Anita will cache the distribution sets, boot floppies, and a hard disk
image in a directory "netbsd-<hash>" under the current working
directory, effectively turning the install() method a no-op if it is
invoked again without first removing the cached files.  If you remove
just the hard disk image (wd0.img), install() will recreate it from
the cached distribution files.

To boot the newly installed hard disk image and get a login prompt,
type "interact" instead of "install", for example:

   ./anita interact i386cd-4.0.iso

To kill the virtual machine and return to Python, type control-a x.

Anita runs qemu with the "-snapshot" flag, so if you log in and make
changes to the system, they will not be saved to the disk image file
by default.

Anita has successfully installed the NetBSD 2.1, 3.1, and 4.0 releases
and a number of recent daily binary snapshots and local builds.
Releases prior to 4.0 will install correctly, but for some unknown
reason, booting the resulting hard disk image doesn't work (it hangs
after the "root on ffs" message).  Perhaps someone can figure out why
this happens, or even fix it.  Booting NetBSD 4.0 or -current works.

Please send any comments, bug reports, or patches to gson@gson.org.
