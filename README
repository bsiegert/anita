This is the documentation for Anita, an Automated NetBSD Installation
and Test Application.

Anita is an experimental tool for automated testing of the NetBSD/i386
installation procedure.  Using Anita, you can download a NetBSD/i386
distribution and install it in a qemu virtual machine in a fully
automated fashion.  It's fun to watch, and it's useful for automated
testing; Anita has already helped find several bugs in NetBSD.

Anita works by "screen scraping" the sysinst output over an emulated
serial console and scripting the installation procedure.  Anita is
written in Python using the pexpect module.

Anita is still a work in progress.  Currently, it only knows how to
install the i386 port of NetBSD, but it should be possible to add
support for installing other ports, as well as cross-installation
setups where the machine running Anita is a different architecture
from the virtual machine being installed on.

If you want to play with Anita, here is what you need:

 - The latest Anita tarball from
   <http://www.gson.org/netbsd/anita/download/>

 - A suitable NetBSD host system to run Anita on.  It has been tested
   on NetBSD 4.0, 5.0, and 5.0.1.

   The following pkgsrc packages are required:

     - emulators/qemu
     - lang/python
     - devel/py-pexpect
     - sysutils/cdrtools

 - A network connection for downloading installation file sets,
   or a local release build tree

 - About a gigabyte of free disk space

Unpack the Anita tarball and cd into the resulting directory.  Then
install Anita by running

   sudo python2.4 setup.py install

(if you have another version of python installed, change the
version number as appropriate).

You should now be able to download and install a NetBSD release in a
virtual machine using a one-line shell command.  For example, to
install NetBSD 5.0.1 from the master NetBSD FTP site, enter

   anita install http://ftp.netbsd.org/pub/NetBSD/NetBSD-5.0.1/i386/

To install a snapshot, use something like the following.  The URL in
this example will have expired by the time you read this, but if you
replace the date with that of a recent successful daily build,
it should work (modulo bugs in the snapshot itself):

   anita install http://ftp.netbsd.org/pub/NetBSD-daily/netbsd-4/200802140000Z/i386/

If you have built NetBSD locally using "build.sh -R", you can point
Anita directly at the RELEASEDIR using a file: URL like the following:

  anita install file:///path/to/releasedir/i386/

Anita will create a subdirectory under the current working directory
and cache the distribution sets, boot floppies, and a hard disk image
in it.  The directory name will be a unique name generated from the
URL, looking something like

  work-http---ftp.netbsd.org-pub-NetBSD-NetBSD-5.0.1-i386-+a4c39

When you rerun Anita with the same URL, files that already exist in
the cache directory will not be re-downloaded or rebuilt, so if you
run you "anita install" with the same URL twice in a row, the second
run will effectively be a no-op, and if you rerun "anita interact",
the system will be booted from the existing disk image, skipping the
installation stage.  To force things to be redone, simply remove the
cache directory.  If you remove just the hard disk image (wd0.img),
"anita install" will recreate it from the cached distribution files.

To boot the newly installed hard disk image and get a login prompt,
type "interact" instead of "install", for example:

   anita interact http://ftp.netbsd.org/pub/NetBSD/NetBSD-4.0/i386/

To kill the virtual machine, type control-a x.

Anita runs qemu with the "-snapshot" flag, so if you log in and make
changes to the system, they will not be saved to the disk image file
by default.

Anita has successfully installed the NetBSD 2.1, 3.1, 4.0, 5.0, and
5.0.1 releases and a number of daily binary snapshots and local
builds.  Releases prior to 4.0 will install correctly, but for some
unknown reason, booting the resulting hard disk image doesn't work (it
hangs after the "root on ffs" message).  Perhaps someone can figure
out why this happens, or even fix qemu to deal with it.

Please send any comments, bug reports, or patches to gson@gson.org.
